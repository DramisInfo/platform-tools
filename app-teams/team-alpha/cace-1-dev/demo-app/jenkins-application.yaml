apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: jenkins
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: team-alpha-jenkins
    server: "https://kubernetes.default.svc"
  project: team-alpha
  source:
    # Using the deprecated stable/jenkins chart (1.9.x era) because Jenkins 2.176.1
    # is an LTS release from July 2019. The modern charts.jenkins.io chart requires
    # Jenkins 2.249+ due to plugin version requirements.
    repoURL: "https://charts.helm.sh/stable"
    chart: jenkins
    targetRevision: 1.9.9
    helm:
      valuesObject:
        master:
          image: "jenkins/jenkins"
          tag: "2.176.1"
          # Run as jenkins user (uid 1000) to satisfy the psp-pods-must-run-as-nonroot
          # OPA Gatekeeper constraint active on this cluster.
          runAsUser: 1000
          fsGroup: 1000
          serviceType: ClusterIP
          jenkinsUrl: "https://jenkins.cace-1-dev.dramisinfo.com"
          # Base plugins required by the chart + additional plugins compatible with Jenkins 2.176.1
          installPlugins:
            - kubernetes:1.21.2
            - workflow-job:2.36
            - workflow-aggregator:2.6
            - credentials-binding:1.20
            - git:4.0.0
            - configuration-as-code:1.32
            - locale:1.4
            - github:1.29.5
            - github-branch-source:2.6.0
          # Inject GitHub App secret keys as environment variables.
          # Note: additionalExistingSecrets is not available in chart 1.9.x.
          # Instead we use envVars with secretKeyRef, and reference them in JCasC
          # as ${GITHUB_APP_ID} and ${GITHUB_PRIVATE_KEY}.
          envVars:
            - name: GITHUB_APP_ID
              valueFrom:
                secretKeyRef:
                  name: jenkins-github-app
                  key: app-id
            - name: GITHUB_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: jenkins-github-app
                  key: private-key
          JCasC:
            enabled: true
            defaultConfig: true
            pluginVersion: "1.32"
            configScripts:
              locale: |
                appearance:
                  locale:
                    ignoreAcceptLanguage: true
                    systemLocale: "en"
              github: |
                credentials:
                  system:
                    domainCredentials:
                      - credentials:
                          - gitHubApp:
                              appID: "${GITHUB_APP_ID}"
                              description: "GitHub App"
                              id: "github-app"
                              privateKey: "${GITHUB_PRIVATE_KEY}"
                unclassified:
                  gitHubPluginConfig:
                    configs:
                      - credentialsId: "github-app"
                        name: "GitHub"
                        apiUrl: "https://api.github.com"
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          javaOpts: "-Xms256m -Xmx512m -Duser.language=en -Duser.country=US"
        persistence:
          enabled: true
          size: 5Gi
        serviceAccount:
          create: true
        # NOTE: extraObjects is not supported in stable/jenkins 1.9.x.
        # The VirtualService for jenkins.cace-1-dev.dramisinfo.com must be
        # managed separately (e.g., via the virtualservice.yaml in this folder
        # or as a standalone ArgoCD Application).
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
