apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: jenkins
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: team-alpha-jenkins
    server: "https://kubernetes.default.svc"
  project: team-alpha
  # spec.sources (multi-source) allows the VirtualService to be managed as part
  # of the same ArgoCD Application as the Helm chart, so it appears together in the UI.
  sources:
    - # Using the deprecated stable/jenkins chart (1.9.x era) because Jenkins 2.176.1
      # is an LTS release from July 2019. The modern charts.jenkins.io chart requires
      # Jenkins 2.249+ due to plugin version requirements.
      repoURL: "https://charts.helm.sh/stable"
      chart: jenkins
      targetRevision: 1.9.9
      helm:
        valuesObject:
          master:
            image: "jenkins/jenkins"
            tag: "2.176.1"
            # Run as jenkins user (uid 1000) to satisfy the psp-pods-must-run-as-nonroot
            # OPA Gatekeeper constraint active on this cluster.
            runAsUser: 1000
            fsGroup: 1000
            serviceType: ClusterIP
            jenkinsUrl: "https://jenkins.cace-1-dev.dramisinfo.com"
            # Base plugins required by the chart + additional plugins compatible with Jenkins 2.176.1
            # Inject GitHub App secret keys as environment variables.
            # Note: additionalExistingSecrets is not available in chart 1.9.x.
            # Instead we use envVars with secretKeyRef, and reference them in JCasC
            # as ${GITHUB_APP_ID} and ${GITHUB_PRIVATE_KEY}.
            JCasC:
              enabled: true
              # defaultConfig generates a Kubernetes cloud config which requires the
              # kubernetes plugin to be loaded at JCasC init time. With Jenkins 2.176.1
              # this causes a boot failure: "No hudson.slaves.Cloud implementation
              # found for kubernetes". Disable it since we use custom configScripts.
              defaultConfig: false
              pluginVersion: "1.32"
              configScripts:
                # NOTE: The 'appearance' JCasC root element did not exist in
                # JCasC 1.32 / Jenkins 2.176.1 â€” locale must be set manually
                # via the UI or via javaOpts (already set below).
            resources:
              requests:
                cpu: "250m"
                memory: "512Mi"
              limits:
                cpu: "1000m"
                memory: "1Gi"
            javaOpts: "-Xms256m -Xmx512m -Duser.language=en -Duser.country=US"
          persistence:
            enabled: true
            size: 5Gi
          serviceAccount:
            create: true
    - # Second source: bedag/raw chart to embed the VirtualService inline.
      # stable/raw does not exist; bedag/raw is the maintained equivalent.
      # This avoids needing a separate Git file while still appearing under
      # the same Jenkins Application in the ArgoCD UI.
      repoURL: "https://bedag.github.io/helm-charts/"
      chart: raw
      targetRevision: 2.0.2
      helm:
        valuesObject:
          resources:
            - apiVersion: networking.istio.io/v1beta1
              kind: VirtualService
              metadata:
                name: jenkins
                namespace: team-alpha-jenkins
              spec:
                hosts:
                  - jenkins.cace-1-dev.dramisinfo.com
                gateways:
                  - istio-system/shared-gateway
                http:
                  - route:
                      - destination:
                          host: jenkins
                          port:
                            number: 8080
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
