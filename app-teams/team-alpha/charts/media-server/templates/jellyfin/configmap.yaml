{{- if .Values.jellyfin.enabled }}
{{- if .Values.jellyfin.config.autoSetup }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "media-server.fullname" . }}-jellyfin-config
  labels:
    {{- include "media-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: jellyfin
data:
  system.xml: |
    <?xml version="1.0" encoding="utf-8"?>
    <ServerConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
      <IsStartupWizardCompleted>true</IsStartupWizardCompleted>
      <EnableUPnP>false</EnableUPnP>
      <PublicPort>8096</PublicPort>
      <PublicHttpsPort>8920</PublicHttpsPort>
      <HttpServerPortNumber>8096</HttpServerPortNumber>
      <HttpsPortNumber>8920</HttpsPortNumber>
      <EnableHttps>false</EnableHttps>
      <EnableRemoteAccess>true</EnableRemoteAccess>
      <CertificatePath />
      <CertificatePassword />
      <IsPortAuthorized>true</IsPortAuthorized>
      <QuickConnectAvailable>false</QuickConnectAvailable>
      <EnableRemoteControlOfSharedDevices>false</EnableRemoteControlOfSharedDevices>
      <ServerName>{{ .Values.jellyfin.config.serverName | default "Jellyfin" }}</ServerName>
    </ServerConfiguration>

  network.xml: |
    <?xml version="1.0" encoding="utf-8"?>
    <NetworkConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
      <RequireHttps>false</RequireHttps>
      <BaseUrl />
      <PublicHttpsPort>8920</PublicHttpsPort>
      <HttpServerPortNumber>8096</HttpServerPortNumber>
      <HttpsPortNumber>8920</HttpsPortNumber>
      <EnableHttps>false</EnableHttps>
      <PublicPort>8096</PublicPort>
      <EnableIPV6>false</EnableIPV6>
      <EnableIPV4>true</EnableIPV4>
      <EnableRemoteAccess>true</EnableRemoteAccess>
      {{- if .Values.jellyfin.config.publicUrl }}
      <WanDdns>{{ .Values.jellyfin.config.publicUrl }}</WanDdns>
      {{- end }}
    </NetworkConfiguration>

  init-script.sh: |
    #!/bin/sh
    set -e
    
    CONFIG_DIR="/config"
    
    echo "Initializing Jellyfin configuration..."
    
    # Create necessary directories
    mkdir -p "$CONFIG_DIR/config"
    mkdir -p "$CONFIG_DIR/data"
    mkdir -p "$CONFIG_DIR/log"
    
    # Copy system.xml if it doesn't exist
    if [ ! -f "$CONFIG_DIR/config/system.xml" ]; then
      echo "Creating system.xml..."
      cp /tmp/jellyfin-config/system.xml "$CONFIG_DIR/config/system.xml"
    else
      echo "system.xml already exists, skipping..."
    fi
    
    # Copy network.xml if it doesn't exist
    if [ ! -f "$CONFIG_DIR/config/network.xml" ]; then
      echo "Creating network.xml..."
      cp /tmp/jellyfin-config/network.xml "$CONFIG_DIR/config/network.xml"
    else
      echo "network.xml already exists, skipping..."
    fi
    
    echo "Jellyfin configuration initialization complete!"
{{- end }}
{{- end }}
