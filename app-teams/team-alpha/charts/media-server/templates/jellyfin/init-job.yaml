{{- if and .Values.jellyfin.enabled .Values.jellyfin.config.adminUser.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "media-server.fullname" . }}-jellyfin-admin
  labels:
    {{- include "media-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: jellyfin
type: Opaque
stringData:
  username: {{ .Values.jellyfin.config.adminUser.username | quote }}
  password: {{ .Values.jellyfin.config.adminUser.password | quote }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "media-server.fullname" . }}-jellyfin-init-{{ .Release.Revision | default "1" }}
  labels:
    {{- include "media-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: jellyfin-init
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    metadata:
      labels:
        {{- include "media-server.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: jellyfin-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-admin
        image: curlimages/curl:8.5.0
        env:
        - name: JELLYFIN_URL
          value: "http://{{ include "media-server.fullname" . }}-jellyfin:{{ .Values.jellyfin.service.port }}"
        - name: ADMIN_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ include "media-server.fullname" . }}-jellyfin-admin
              key: username
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "media-server.fullname" . }}-jellyfin-admin
              key: password
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          echo "==> Waiting for Jellyfin to be ready..."
          for i in $(seq 1 60); do
            if curl -f -s "${JELLYFIN_URL}/health" > /dev/null 2>&1; then
              echo "==> Jellyfin is healthy!"
              break
            fi
            [ $i -eq 60 ] && { echo "ERROR: Jellyfin did not start in time"; exit 1; }
            sleep 5
          done
          
          # Check if any users exist (wizard completed)
          if curl -s "${JELLYFIN_URL}/Users/Public" 2>/dev/null | grep -q '"Id"'; then
            echo "==> Setup already completed, users exist"
            exit 0
          fi
          
          echo "==> Creating admin user..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${JELLYFIN_URL}/Startup/User" \
            -H "Content-Type: application/json" \
            -d "{\"Name\": \"${ADMIN_USERNAME}\", \"Password\": \"${ADMIN_PASSWORD}\"}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" != "204" ] && [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Failed to create user (HTTP $HTTP_CODE): $(echo "$RESPONSE" | head -n-1)"
            exit 1
          fi
          
          echo "==> Completing wizard..."
          curl -s -X POST "${JELLYFIN_URL}/Startup/Complete"
          sleep 10
          
          echo "==> Authenticating as admin user..."
          AUTH_RESPONSE=$(curl -s -X POST "${JELLYFIN_URL}/Users/AuthenticateByName" \
            -H "Content-Type: application/json" \
            -H "X-Emby-Authorization: MediaBrowser Client=\"Jellyfin Init\", Device=\"Init Job\", DeviceId=\"init-job\", Version=\"1.0.0\"" \
            -d "{\"Username\": \"${ADMIN_USERNAME}\", \"Pw\": \"${ADMIN_PASSWORD}\"}")
          
          ACCESS_TOKEN=$(echo "$AUTH_RESPONSE" | grep -o '"AccessToken":"[^"]*' | cut -d'"' -f4)
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: Failed to authenticate. Response: $AUTH_RESPONSE"
            exit 1
          fi
          
          echo "==> Creating media libraries..."
          {{- range .Values.jellyfin.config.libraries }}
          echo "  - {{ .name }} ({{ .type }})"
          curl -s -X POST "${JELLYFIN_URL}/Library/VirtualFolders?collectionType={{ .type }}&refreshLibrary=false&name={{ .name | urlquery }}" \
            -H "X-Emby-Token: $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"LibraryOptions":{"PathInfos":[{{- range $i, $p := .paths }}{{- if $i}},{{- end }}{"Path":"{{$p}}"}{{- end }}]}}'
          {{- end }}
          
          echo "==> Setup complete!"
{{- end }}
