{{- if and .Values.jellyfin.enabled .Values.jellyfin.config.adminUser.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "media-server.fullname" . }}-jellyfin-admin
  labels:
    {{- include "media-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: jellyfin
type: Opaque
stringData:
  username: {{ .Values.jellyfin.config.adminUser.username | quote }}
  password: {{ .Values.jellyfin.config.adminUser.password | quote }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "media-server.fullname" . }}-jellyfin-init-{{ .Release.Revision | default "1" }}
  labels:
    {{- include "media-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: jellyfin-init
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    metadata:
      labels:
        {{- include "media-server.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: jellyfin-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-admin
        image: curlimages/curl:8.5.0
        env:
        - name: JELLYFIN_URL
          value: "http://{{ include "media-server.fullname" . }}-jellyfin:{{ .Values.jellyfin.service.port }}"
        - name: ADMIN_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ include "media-server.fullname" . }}-jellyfin-admin
              key: username
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "media-server.fullname" . }}-jellyfin-admin
              key: password
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          echo "Waiting for Jellyfin to be ready..."
          
          # Wait for Jellyfin to start (max 5 minutes)
          for i in $(seq 1 60); do
            if curl -f -s "${JELLYFIN_URL}/health" > /dev/null 2>&1; then
              echo "Jellyfin is ready!"
              break
            fi
            echo "Waiting for Jellyfin... ($i/60)"
            sleep 5
          done
          
          # Check if startup wizard is completed
          if curl -s "${JELLYFIN_URL}/Startup/Configuration" | grep -q '"IsStartupWizardCompleted":true'; then
            echo "Startup wizard already completed, checking for existing users..."
            
            # Try to get users (this will fail if no auth is set up)
            USER_COUNT=$(curl -s "${JELLYFIN_URL}/Users" | grep -o '"Id"' | wc -l || echo "0")
            
            if [ "$USER_COUNT" -gt "0" ]; then
              echo "Admin user already exists."
            fi
          fi
          
          # Check if user exists, if not create
          USER_COUNT=$(curl -s "${JELLYFIN_URL}/Users/Public" | grep -o '"Id"' | wc -l || echo "0")
          if [ "$USER_COUNT" -eq "0" ]; then
            echo "Creating initial admin user..."
            
            # Create the initial user via Startup wizard API
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${JELLYFIN_URL}/Startup/User" \
              -H "Content-Type: application/json" \
              -d "{
                \"Name\": \"${ADMIN_USERNAME}\",
                \"Password\": \"${ADMIN_PASSWORD}\"
              }")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)
            
            if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "Admin user created successfully!"
              
              # Complete the startup wizard
              echo "Completing startup wizard..."
              curl -s -X POST "${JELLYFIN_URL}/Startup/Complete"
              
              # Wait a bit for user to be ready
              sleep 5
            else
              echo "Failed to create admin user. HTTP Code: $HTTP_CODE"
              echo "Response: $BODY"
              exit 1
            fi
          else
            echo "Users already exist, skipping user creation."
          fi
          
          echo "Authenticating..."
          
          # Authenticate to get access token
          AUTH_RESPONSE=$(curl -s -X POST "${JELLYFIN_URL}/Users/AuthenticateByName" \
            -H "Content-Type: application/json" \
            -H "X-Emby-Authorization: MediaBrowser Client=\"Jellyfin Init\", Device=\"Init Job\", DeviceId=\"init-job\", Version=\"1.0.0\"" \
            -d "{
              \"Username\": \"${ADMIN_USERNAME}\",
              \"Pw\": \"${ADMIN_PASSWORD}\"
            }")
          
          ACCESS_TOKEN=$(echo "$AUTH_RESPONSE" | grep -o '"AccessToken":"[^"]*' | cut -d'"' -f4)
          USER_ID=$(echo "$AUTH_RESPONSE" | grep -o '"Id":"[^"]*' | cut -d'"' -f4 | head -n1)
          
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "Failed to authenticate!"
            echo "Response: $AUTH_RESPONSE"
            exit 1
          fi
          
          echo "Authenticated successfully! User ID: $USER_ID"
          
          # Get existing libraries
          EXISTING_LIBS=$(curl -s -H "X-Emby-Token: $ACCESS_TOKEN" "${JELLYFIN_URL}/Library/VirtualFolders")
          
          {{- range .Values.jellyfin.config.libraries }}
          echo "Creating library: {{ .name }}..."
          
          # Check if library already exists
          if echo "$EXISTING_LIBS" | grep -q '"Name":"{{ .name }}"'; then
            echo "Library '{{ .name }}' already exists, skipping..."
          else
            # Create library
            curl -s -X POST "${JELLYFIN_URL}/Library/VirtualFolders?collectionType={{ .type }}&refreshLibrary=false&name={{ .name | urlquery }}" \
              -H "X-Emby-Token: $ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "LibraryOptions": {
                  "EnablePhotos": false,
                  "EnableRealtimeMonitor": true,
                  "EnableChapterImageExtraction": false,
                  "ExtractChapterImagesDuringLibraryScan": false,
                  "PathInfos": [
                    {{- range $index, $path := .paths }}
                    {{- if $index }},{{- end }}
                    {"Path": "{{ $path }}"}
                    {{- end }}
                  ]
                }
              }'
            
            echo "Library '{{ .name }}' created!"
          fi
          
          {{- end }}
          
          echo "Jellyfin initialization complete!"
{{- end }}
