apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: artifactory
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  
  source:
    repoURL: https://charts.jfrog.io
    targetRevision: 107.125.9  # Latest version - Artifactory 7.125.9
    chart: artifactory
    helm:
      releaseName: artifactory
      values: |
        # Use external PostgreSQL via CNPG (CloudNativePG)
        postgresql:
          enabled: false
        
        # External database configuration for CNPG
        database:
          type: postgresql
          driver: org.postgresql.Driver
          url: "jdbc:postgresql://artifactory-pg-rw.artifactory.svc.cluster.local:5432/artifactory"
          user: artifactory
          # Password will be provided via secret
          secrets:
            password:
              name: artifactory-db-credentials
              key: password
        
        # Single-node configuration (no HA for test environment)
        artifactory:
          replicaCount: 1
          
          # Master and join keys via secrets (to be created separately)
          masterKeySecretName: artifactory-keys
          joinKeySecretName: artifactory-keys
          
          # License will be added via UI after deployment
          
          # Node selector if needed for specific nodes
          # nodeSelector: {}
          
          # Resource limits for small homelab environment
          resources:
            requests:
              memory: "2Gi"
              cpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2"
          
          # Persistence configuration
          persistence:
            enabled: true
            size: 100Gi
            # storageClassName: local-path  # Adjust based on your storage class
        
        # Nginx configuration (Artifactory's internal nginx)
        nginx:
          enabled: true
          service:
            type: ClusterIP  # Using ClusterIP since we have ingress controller
          resources:
            requests:
              memory: "250Mi"
              cpu: "100m"
            limits:
              memory: "500Mi"
              cpu: "500m"
        
        # Ingress configuration (using existing nginx ingress controller)
        ingress:
          enabled: true
          className: nginx
          hosts:
            - artifactory.cace-1-dev.dramisinfo.com
          annotations:
            cert-manager.io/cluster-issuer: "letsencrypt-prod"
            nginx.ingress.kubernetes.io/proxy-body-size: "0"
            nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
            nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
          tls:
            - secretName: artifactory-tls
              hosts:
                - artifactory.cace-1-dev.dramisinfo.com
        
        # Container security context
        containerSecurityContext:
          enabled: true
          runAsNonRoot: true
          privileged: false
          allowPrivilegeEscalation: false
        
        # Disable internal PostgreSQL security context (not needed since using CNPG)
        # postgresql security context is not relevant when postgresql.enabled=false

  destination:
    server: https://kubernetes.default.svc
    namespace: artifactory

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

---
# CloudNativePG Cluster for Artifactory
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: artifactory-pg
  namespace: artifactory
spec:
  instances: 1  # Single instance for test environment
  
  postgresql:
    parameters:
      max_connections: "1500"
      shared_buffers: "512MB"
      effective_cache_size: "1536MB"
      maintenance_work_mem: "128MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "349kB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"
  
  bootstrap:
    initdb:
      database: artifactory
      owner: artifactory
      secret:
        name: artifactory-db-credentials
  
  storage:
    size: 50Gi
    # storageClass: local-path  # Adjust based on your storage class
  
  monitoring:
    enabled: true
    podMonitorEnabled: true

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1"

---
# Database credentials secret
apiVersion: v1
kind: Secret
metadata:
  name: artifactory-db-credentials
  namespace: artifactory
type: Opaque
stringData:
  username: artifactory
  password: "artifactory-db-password-test123"

---
# Artifactory master and join keys
apiVersion: v1
kind: Secret
metadata:
  name: artifactory-keys
  namespace: artifactory
type: Opaque
stringData:
  master-key: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
  join-key: "fedcba0987654321fedcba0987654321fedcba0987654321fedcba0987654321"
