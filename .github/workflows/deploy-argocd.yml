name: Refresh ArgoCD Applications

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh even if no changes'
        required: false
        default: false
        type: boolean

env:
  ARGOCD_URL: https://argo.cace-1-dev.dramisinfo.com

jobs:
  refresh-argocd:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Refresh platform-tools root application
        id: sync-platform-tools
        run: |
          echo "ðŸ”„ Refreshing platform-tools root application..."
          
          SYNC_RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/platform-tools-refresh.json \
            -X POST \
            -H "Content-Type: application/json" \
            ${{ env.ARGOCD_URL }}/api/v1/applications/platform-tools/sync)
          
          echo "platform-tools HTTP Status: $SYNC_RESPONSE"
          
          if [[ "$SYNC_RESPONSE" == "200" ]]; then
            echo "âœ… platform-tools refresh initiated successfully"
          else
            echo "âŒ platform-tools refresh failed with status: $SYNC_RESPONSE"
            cat /tmp/platform-tools-refresh.json
            exit 1
          fi

      - name: Refresh platform-core application
        id: sync-platform-core
        run: |
          echo "ðŸ”„ Refreshing platform-core application..."
          
          SYNC_RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/platform-core-refresh.json \
            -X POST \
            -H "Content-Type: application/json" \
            ${{ env.ARGOCD_URL }}/api/v1/applications/platform-core/sync)
          
          echo "platform-core HTTP Status: $SYNC_RESPONSE"
          
          if [[ "$SYNC_RESPONSE" == "200" ]]; then
            echo "âœ… platform-core refresh initiated successfully"
          else
            echo "âŒ platform-core refresh failed with status: $SYNC_RESPONSE"
            cat /tmp/platform-core-refresh.json
            exit 1
          fi

      - name: Refresh team applications
        id: sync-team-apps
        run: |
          echo "ðŸ”„ Refreshing team applications..."
          
          # Get all applications that belong to team projects (team-*)
          TEAM_APPS=$(curl -s ${{ env.ARGOCD_URL }}/api/v1/applications | \
            jq -r '.items[] | select(.spec.project | test("^team-")) | .metadata.name')
          
          if [[ -z "$TEAM_APPS" ]]; then
            echo "âš ï¸ No team applications found"
            exit 0
          fi
          
          echo "Found team applications: $TEAM_APPS"
          
          for app in $TEAM_APPS; do
            echo "ðŸ”„ Refreshing $app..."
            SYNC_RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/${app}-refresh.json \
              -X POST \
              -H "Content-Type: application/json" \
              ${{ env.ARGOCD_URL }}/api/v1/applications/${app}/sync)
            
            if [[ "$SYNC_RESPONSE" == "200" ]]; then
              echo "âœ… $app refresh initiated successfully"
            else
              echo "âŒ $app refresh failed with status: $SYNC_RESPONSE"
              cat /tmp/${app}-refresh.json
            fi
          done

      - name: Wait and Check Application Status
        run: |
          echo "â³ Waiting 30 seconds for sync operations to progress..."
          sleep 30
          
          echo "ðŸ” Checking application statuses..."
          
          for app in platform-tools platform-core demo-chart; do
            echo ""
            echo "--- $app ---"
            curl -s ${{ env.ARGOCD_URL }}/api/v1/applications/$app 2>/dev/null | \
              jq -r 'if .status then "Sync: \(.status.sync.status // "N/A"), Health: \(.status.health.status // "N/A")" else "Application not found or no access" end' || echo "Failed to check $app"
          done

      - name: Generate Summary
        if: always()
        run: |
          echo "## ArgoCD Refresh Summary - CACE-1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Application | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| platform-tools | [View](https://argo.cace-1-dev.dramisinfo.com/applications/platform-tools) |" >> $GITHUB_STEP_SUMMARY
          echo "| platform-core | [View](https://argo.cace-1-dev.dramisinfo.com/applications/platform-core) |" >> $GITHUB_STEP_SUMMARY
          echo "| demo-chart | [View](https://argo.cace-1-dev.dramisinfo.com/applications/demo-chart) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
